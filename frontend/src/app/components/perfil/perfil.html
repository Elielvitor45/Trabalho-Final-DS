<div class="perfil-wrapper">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Carregando perfil...</p>
  </div>

  <!-- Conte√∫do -->
  <div *ngIf="!loading && user" class="perfil-layout">
    
    <!-- Navbar -->
    <nav class="navbar-perfil">
      <div class="navbar-content">
        <div class="logo" (click)="goToHome()">
          <span class="logo-icon">üöó</span>
          <span class="logo-text">LocadoraMax</span>
        </div>
        <div class="navbar-actions">
          <button class="btn-nav" (click)="goToHome()">üè† Home</button>
          <button class="btn-nav-danger" (click)="logout()">üö™ Sair</button>
        </div>
      </div>
    </nav>

    <!-- Container Principal -->
    <div class="perfil-container">
      
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Avatar e Nome -->
        <div class="profile-header">
          <div class="avatar-large">
            {{ user.nome ? user.nome.charAt(0).toUpperCase() : '?' }}
          </div>
          <h1 class="profile-name">{{ user.nome }}</h1>
          <p class="profile-email">{{ user.email }}</p>
        </div>

        <!-- Informa√ß√µes de Contato -->
        <div class="sidebar-section">
          <h3 class="sidebar-title">Informa√ß√µes Pessoais</h3>
          
          <div class="contact-item">
            <span class="contact-icon">üìã</span>
            <div class="contact-info">
              <span class="contact-label">CPF</span>
              <span class="contact-value">{{ formatCPF(user.cpf) || 'N√£o informado' }}</span>
            </div>
          </div>

          <div class="contact-item">
            <span class="contact-icon">üìû</span>
            <div class="contact-info">
              <span class="contact-label">Telefone</span>
              <span class="contact-value">{{ formatTelefone(user.telefone) || 'N√£o informado' }}</span>
            </div>
          </div>

          <div class="contact-item">
            <span class="contact-icon">‚úâÔ∏è</span>
            <div class="contact-info">
              <span class="contact-label">Email</span>
              <span class="contact-value">{{ user.email }}</span>
            </div>
          </div>
        </div>

        <!-- Estat√≠sticas R√°pidas -->
        <div class="sidebar-section" *ngIf="!loadingEstatisticas && estatisticas">
          <h3 class="sidebar-title">üìä Estat√≠sticas</h3>
          
          <div class="stat-mini">
            <span class="stat-mini-value">{{ estatisticas.totalLocacoes }}</span>
            <span class="stat-mini-label">Total Loca√ß√µes</span>
          </div>

          <div class="stat-mini">
            <span class="stat-mini-value">{{ estatisticas.locacoesAtivas }}</span>
            <span class="stat-mini-label">Ativas</span>
          </div>

          <div class="stat-mini">
            <span class="stat-mini-value">{{ formatarValor(estatisticas.valorTotalGasto) }}</span>
            <span class="stat-mini-label">Total Gasto</span>
          </div>
        </div>
      </aside>

      <!-- Conte√∫do Principal -->
      <main class="main-content">
        
        <!-- Mensagens -->
        <div *ngIf="successMessage" class="alert alert-success">
          ‚úì {{ successMessage }}
        </div>
        
        <div *ngIf="errorMessage" class="alert alert-error">
          ‚úó {{ errorMessage }}
        </div>

        <!-- Endere√ßo -->
        <section class="content-section">
          <div class="section-header-horizontal">
            <h2 class="section-title-main">üìç Endere√ßo</h2>
            <button class="btn-icon" (click)="iniciarEdicaoEndereco()" *ngIf="!editandoEndereco">
              {{ user.endereco ? '‚úèÔ∏è Editar' : '+ Adicionar' }}
            </button>
          </div>

          <!-- Modo Visualiza√ß√£o -->
          <div *ngIf="!editandoEndereco && user.endereco" class="endereco-display">
            <div class="endereco-line">
              <strong>{{ user.endereco.logradouro }}, {{ user.endereco.numero }}</strong>
              <span *ngIf="user.endereco.complemento"> - {{ user.endereco.complemento }}</span>
            </div>
            <div class="endereco-line">
              {{ user.endereco.bairro }} - {{ user.endereco.cidade }}/{{ user.endereco.estado }}
            </div>
            <div class="endereco-line">
              CEP: {{ formatCEP(user.endereco.cep) }}
            </div>
          </div>

          <div *ngIf="!editandoEndereco && !user.endereco" class="empty-state">
            <p>üì≠ Nenhum endere√ßo cadastrado</p>
            <small>Clique em "Adicionar" para cadastrar seu endere√ßo</small>
          </div>

          <!-- Modo Edi√ß√£o -->
          <form *ngIf="editandoEndereco" [formGroup]="enderecoForm" (ngSubmit)="salvarEndereco()" class="form-endereco">
            <div class="form-row">
              <div class="form-col-3">
                <label>CEP *</label>
                <input type="text" formControlName="cep" placeholder="00000-000" maxlength="8" (input)="formatCEPInput($event)">
                <span class="form-error" *ngIf="enderecoForm.get('cep')?.invalid && enderecoForm.get('cep')?.touched">
                  CEP inv√°lido
                </span>
              </div>

              <div class="form-col">
                <label>Logradouro *</label>
                <input type="text" formControlName="logradouro" placeholder="Rua, Avenida...">
              </div>

              <div class="form-col-3">
                <label>N√∫mero *</label>
                <input type="text" formControlName="numero" placeholder="123">
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <label>Complemento</label>
                <input type="text" formControlName="complemento" placeholder="Apto, Sala... (opcional)">
              </div>

              <div class="form-col">
                <label>Bairro *</label>
                <input type="text" formControlName="bairro" placeholder="Bairro">
              </div>
            </div>

            <div class="form-row">
              <div class="form-col">
                <label>Cidade *</label>
                <input type="text" formControlName="cidade" placeholder="Cidade">
              </div>

              <div class="form-col-4">
                <label>Estado *</label>
                <input type="text" formControlName="estado" placeholder="SP" maxlength="2" style="text-transform: uppercase;">
              </div>
            </div>

            <div class="form-actions-inline">
              <button type="button" class="btn-outline" (click)="cancelarEdicaoEndereco()">Cancelar</button>
              <button type="submit" class="btn-primary-custom" [disabled]="enderecoForm.invalid || salvandoEndereco">
                {{ salvandoEndereco ? 'Salvando...' : 'Salvar' }}
              </button>
            </div>
          </form>
        </section>

        <!-- Hist√≥rico de Loca√ß√µes -->
        <section class="content-section">
          <div class="section-header-horizontal">
            <h2 class="section-title-main">üìã Hist√≥rico de Loca√ß√µes</h2>
            <button class="btn-icon" (click)="loadHistoricoLocacoes()">
              {{ mostrarHistorico ? '‚ñº Ocultar' : '‚ñ∂ Mostrar' }}
            </button>
          </div>

          <div *ngIf="loadingLocacoes" class="empty-state">
            <p>Carregando hist√≥rico...</p>
          </div>

          <div *ngIf="mostrarHistorico && !loadingLocacoes && locacoes.length > 0" class="timeline">
            <div *ngFor="let locacao of locacoes; let i = index" class="timeline-item">
              <div class="timeline-marker" [class.active]="locacao.status === 'ATIVA'"></div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <h3 class="timeline-title">
                    {{ locacao.veiculo?.marca || 'Ve√≠culo' }} {{ locacao.veiculo?.modelo || '' }}
                  </h3>
                  <span class="badge" [ngClass]="getStatusClass(locacao.status)">
                    {{ locacao.status }}
                  </span>
                </div>
                <div class="timeline-details">
                  <div class="detail-row">
                    <span class="detail-icon">üìÖ</span>
                    <span>{{ formatarData(locacao.dataRetirada) }} at√© {{ formatarData(locacao.dataDevolucao) }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-icon">üí∞</span>
                    <strong class="valor-destaque">{{ formatarValor(locacao.valorTotal) }}</strong>
                  </div>
                  <div class="detail-row" *ngIf="locacao.observacoes">
                    <span class="detail-icon">üìù</span>
                    <span>{{ locacao.observacoes }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="mostrarHistorico && !loadingLocacoes && locacoes.length === 0" class="empty-state">
            <p>üì≠ Nenhuma loca√ß√£o encontrada</p>
            <small>Quando voc√™ alugar um ve√≠culo, ele aparecer√° aqui</small>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && errorMessage && !user" class="error-page">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h2>Erro ao carregar perfil</h2>
    <p>{{ errorMessage }}</p>
    <button class="btn-primary-custom" (click)="goToHome()">Voltar para Home</button>
  </div>
</div>
