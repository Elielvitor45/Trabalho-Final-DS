<div class="perfil-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Carregando perfil...</p>
  </div>

  <!-- Error -->
  <div *ngIf="!loading && errorMessage && !user" class="error-container">
    <div class="error-message">{{ errorMessage }}</div>
    <button class="btn-primary" (click)="goToHome()">Voltar para Home</button>
  </div>

  <!-- Profile Content -->
  <div *ngIf="!loading && user" class="perfil-card">
    <!-- Header -->
    <div class="perfil-header">
      <div class="logo" (click)="goToHome()">
        <h1>ğŸš— LocadoraMax</h1>
      </div>

      <div class="user-avatar">
        <div class="avatar-circle">
          {{ user.nome ? user.nome.charAt(0).toUpperCase() : '?' }}
        </div>
        <h2 class="user-name">{{ user.nome }}</h2>
        <p class="user-email">{{ user.email }}</p>
      </div>
    </div>

    <!-- User Info -->
    <div class="perfil-content">
      <!-- Messages -->
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>

      <div *ngIf="successMessage" class="success-message">
        {{ successMessage }}
      </div>

      <!-- InformaÃ§Ãµes Pessoais -->
      <div class="section">
        <h3 class="section-title">InformaÃ§Ãµes Pessoais</h3>

        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">ğŸ“‹ CPF</span>
            <span class="info-value">{{ formatCPF(user.cpf) || 'NÃ£o informado' }}</span>
          </div>

          <div class="info-item">
            <span class="info-label">ğŸ“ Telefone</span>
            <span class="info-value">{{ formatTelefone(user.telefone) || 'NÃ£o informado' }}</span>
          </div>

          <div class="info-item">
            <span class="info-label">âœ‰ï¸ Email</span>
            <span class="info-value">{{ user.email }}</span>
          </div>
        </div>
      </div>

      <!-- EndereÃ§o - Modo VisualizaÃ§Ã£o -->
      <div class="section" *ngIf="!editandoEndereco">
        <div class="section-header">
          <h3 class="section-title">EndereÃ§o</h3>
          <button class="btn-edit" (click)="iniciarEdicaoEndereco()">
            {{ user.endereco ? 'âœï¸ Editar' : '+ Adicionar' }}
          </button>
        </div>

        <div *ngIf="user.endereco" class="info-grid">
          <div class="info-item full-width">
            <span class="info-label">ğŸ“ Logradouro</span>
            <span class="info-value">{{ user.endereco.logradouro }}, {{ user.endereco.numero }}</span>
          </div>

          <div class="info-item" *ngIf="user.endereco.complemento">
            <span class="info-label">ğŸ¢ Complemento</span>
            <span class="info-value">{{ user.endereco.complemento }}</span>
          </div>

          <div class="info-item">
            <span class="info-label">ğŸ˜ï¸ Bairro</span>
            <span class="info-value">{{ user.endereco.bairro }}</span>
          </div>

          <div class="info-item">
            <span class="info-label">ğŸ™ï¸ Cidade</span>
            <span class="info-value">{{ user.endereco.cidade }} - {{ user.endereco.estado }}</span>
          </div>

          <div class="info-item">
            <span class="info-label">ğŸ“® CEP</span>
            <span class="info-value">{{ formatCEP(user.endereco.cep) }}</span>
          </div>
        </div>

        <p *ngIf="!user.endereco" class="no-data">Nenhum endereÃ§o cadastrado</p>
      </div>

      <!-- EndereÃ§o - Modo EdiÃ§Ã£o -->
      <div class="section" *ngIf="editandoEndereco">
        <h3 class="section-title">{{ user.endereco ? 'Editar EndereÃ§o' : 'Adicionar EndereÃ§o' }}</h3>

        <form [formGroup]="enderecoForm" (ngSubmit)="salvarEndereco()" class="endereco-form">
          <div class="form-row">
            <div class="form-group form-group-small">
              <label>CEP</label>
              <input type="text" formControlName="cep" placeholder="00000000" maxlength="8"
                (input)="formatCEPInput($event)"
                [class.invalid]="enderecoForm.get('cep')?.invalid && enderecoForm.get('cep')?.touched">
              <span class="error" *ngIf="enderecoForm.get('cep')?.invalid && enderecoForm.get('cep')?.touched">
                CEP deve ter 8 dÃ­gitos
              </span>
            </div>

            <div class="form-group">
              <label>Logradouro</label>
              <input type="text" formControlName="logradouro" placeholder="Rua, Avenida..."
                [class.invalid]="enderecoForm.get('logradouro')?.invalid && enderecoForm.get('logradouro')?.touched">
              <span class="error"
                *ngIf="enderecoForm.get('logradouro')?.invalid && enderecoForm.get('logradouro')?.touched">
                Logradouro Ã© obrigatÃ³rio
              </span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group form-group-small">
              <label>NÃºmero</label>
              <input type="text" formControlName="numero" placeholder="123"
                [class.invalid]="enderecoForm.get('numero')?.invalid && enderecoForm.get('numero')?.touched">
              <span class="error" *ngIf="enderecoForm.get('numero')?.invalid && enderecoForm.get('numero')?.touched">
                NÃºmero Ã© obrigatÃ³rio
              </span>
            </div>

            <div class="form-group">
              <label>Complemento</label>
              <input type="text" formControlName="complemento" placeholder="Apto, Sala... (opcional)">
            </div>
          </div>

          <div class="form-group">
            <label>Bairro</label>
            <input type="text" formControlName="bairro" placeholder="Bairro"
              [class.invalid]="enderecoForm.get('bairro')?.invalid && enderecoForm.get('bairro')?.touched">
            <span class="error" *ngIf="enderecoForm.get('bairro')?.invalid && enderecoForm.get('bairro')?.touched">
              Bairro Ã© obrigatÃ³rio
            </span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Cidade</label>
              <input type="text" formControlName="cidade" placeholder="Cidade"
                [class.invalid]="enderecoForm.get('cidade')?.invalid && enderecoForm.get('cidade')?.touched">
              <span class="error" *ngIf="enderecoForm.get('cidade')?.invalid && enderecoForm.get('cidade')?.touched">
                Cidade Ã© obrigatÃ³ria
              </span>
            </div>

            <div class="form-group form-group-small">
              <label>Estado</label>
              <input type="text" formControlName="estado" placeholder="SP" maxlength="2"
                style="text-transform: uppercase;"
                [class.invalid]="enderecoForm.get('estado')?.invalid && enderecoForm.get('estado')?.touched">
              <span class="error" *ngIf="enderecoForm.get('estado')?.invalid && enderecoForm.get('estado')?.touched">
                Estado deve ter 2 letras
              </span>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="cancelarEdicaoEndereco()" [disabled]="salvandoEndereco">
              Cancelar
            </button>
            <button type="submit" class="btn-save" [disabled]="salvandoEndereco || enderecoForm.invalid">
              {{ salvandoEndereco ? 'Salvando...' : 'Salvar EndereÃ§o' }}
            </button>
          </div>
        </form>
      </div>

      <!-- ========== NOVAS SEÃ‡Ã•ES ========== -->

      <!-- SeÃ§Ã£o de EstatÃ­sticas -->
      <div class="section">
        <h2 class="section-title">ğŸ“Š EstatÃ­sticas</h2>

        <div *ngIf="loadingEstatisticas" class="no-data">
          <p>Carregando estatÃ­sticas...</p>
        </div>

        <div *ngIf="!loadingEstatisticas && estatisticas" class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">ğŸš—</div>
            <div class="stat-value">{{ estatisticas.totalLocacoes }}</div>
            <div class="stat-label">Total de LocaÃ§Ãµes</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-value">{{ estatisticas.locacoesAtivas }}</div>
            <div class="stat-label">LocaÃ§Ãµes Ativas</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">ğŸ</div>
            <div class="stat-value">{{ estatisticas.locacoesFinalizadas }}</div>
            <div class="stat-label">Finalizadas</div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-value">{{ formatarValor(estatisticas.valorTotalGasto) }}</div>
            <div class="stat-label">Total Gasto</div>
          </div>
        </div>

        <div *ngIf="!loadingEstatisticas && !estatisticas" class="no-data">
          <p>Nenhuma estatÃ­stica disponÃ­vel</p>
        </div>
      </div>

      <!-- SeÃ§Ã£o de HistÃ³rico -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">ğŸ“‹ HistÃ³rico de LocaÃ§Ãµes</h2>
          <button class="btn-toggle-historico" (click)="loadHistoricoLocacoes()">
            {{ mostrarHistorico ? 'â–¼ Ocultar' : 'â–¶ Ver HistÃ³rico' }}
          </button>
        </div>

        <div *ngIf="loadingLocacoes" class="no-data">
          <p>Carregando histÃ³rico...</p>
        </div>

        <div *ngIf="mostrarHistorico && !loadingLocacoes && locacoes.length > 0" class="historico-lista">
          <div *ngFor="let locacao of locacoes" class="locacao-card">
            <div class="locacao-header">
              <h3 class="locacao-veiculo">{{ locacao.veiculoNome }}</h3>
              <span class="locacao-status" [ngClass]="getStatusClass(locacao.status)">
                {{ locacao.status }}
              </span>
            </div>

            <div class="locacao-detalhes">
              <div class="locacao-info">
                <span class="info-icon">ğŸ“…</span>
                <span class="info-text">
                  {{ formatarData(locacao.dataInicio) }} atÃ© {{ formatarData(locacao.dataFim) }}
                </span>
              </div>

              <div class="locacao-info">
                <span class="info-icon">ğŸ’µ</span>
                <span class="info-text valor-destaque">
                  {{ formatarValor(locacao.valorTotal) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="mostrarHistorico && !loadingLocacoes && locacoes.length === 0" class="no-data">
          <p>VocÃª ainda nÃ£o possui locaÃ§Ãµes</p>
        </div>
      </div>

      <!-- ========== FIM DAS NOVAS SEÃ‡Ã•ES ========== -->

    </div><!-- .perfil-content -->

    <!-- Actions -->
    <div class="perfil-actions">
      <button class="btn-secondary" (click)="goToHome()">
        Voltar para Home
      </button>
      <button class="btn-danger" (click)="logout()">
        Sair da Conta
      </button>
    </div>
  </div><!-- .perfil-card -->
</div><!-- .perfil-container -->
